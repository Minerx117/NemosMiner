$Request = '2022-08-31 08:58:00: http://127.0.0.1:3999/functions/stat/remove?Pools=%5B{"Name"%3A"NLPoolPlus"%2C"Algorithm"%3A"Allium"%2C"Currency"%3A"GRLC"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Allium"%2C"Currency"%3A"GRLC"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Allium"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Argon2d500"%2C"Currency"%3A"DYN"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"AstralHash"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Bitcore"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Blake2b"%2C"Currency"%3A"TNET"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Blake2b"%2C"Currency"%3A"TNET"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Bmw512"%2C"Currency"%3A"XDN"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Bmw512"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"C11"%2C"Currency"%3A"CHC"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"C11"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"Chia"%2C"Currency"%3A"XCH"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"CryptonightR"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Dedal"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Equihash1445"%2C"Currency"%3A"LTZ"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"Equihash2009"%2C"Currency"%3A""}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Equihash2009"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"Equihash2009"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Equihash2009"%2C"Currency"%3A"KMD"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Equihash2009"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Equihash965"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Ethash"%2C"Currency"%3A"EGEM"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"Groestl"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"Groestl"%2C"Currency"%3A"GRS"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Groestl"%2C"Currency"%3A"GRS"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Groestl"%2C"Currency"%3A"GRS"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"HeavyHash"%2C"Currency"%3A"OBTC"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Honeycomb"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"JeongHash"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"KawPow"%2C"Currency"%3A"PRCO"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"KeccakC"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"Lyra2x2"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"Lyra2x2"%2C"Currency"%3A"MONA"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Lyra2x2"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"Lyra2x2"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Lyra2x2"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Lyra2RE3"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Lyra2Z"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Lyra2Z"%2C"Currency"%3A"ACM"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Lyra2Z"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"MegaBtx"%2C"Currency"%3A"BTX"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"MegaBtx"%2C"Currency"%3A"BTX"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"MyriadGroestl"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"MyriadGroestl"%2C"Currency"%3A"XMY"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"MyriadGroestl"%2C"Currency"%3A"SMLY"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"MyriadGroestl"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Nist5"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"PadiHash"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"PawelHash"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Phi"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Phi2"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Quark"%2C"Currency"%3A""}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"Qubit"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"Qubit"%2C"Currency"%3A"DGB"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Qubit"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Qubit"%2C"Currency"%3A"DGB"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Qubit"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"Randomx"%2C"Currency"%3A"XMR"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Randomx"%2C"Currency"%3A"XMR"}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"Randomx"%2C"Currency"%3A"XMR"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"RandomxArq"%2C"Currency"%3A"GNTL"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"Scrypt"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"Scrypt"%2C"Currency"%3A"LTC"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Scrypt"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"Scrypt"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Scrypt"%2C"Currency"%3A""}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"Sha256"%2C"Currency"%3A""}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"Sha256"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"Sha256"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Sha256"%2C"Currency"%3A""}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"SHA256AsicBoost"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Sha256t"%2C"Currency"%3A"OCP"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"Skein"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"Skein"%2C"Currency"%3A"DGB"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Skein"%2C"Currency"%3A"CRM"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Skein"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"SkunkHash"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Tribus"%2C"Currency"%3A"SCRIV"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"Tribus"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"VerusHash"%2C"Currency"%3A"VRSC"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"VerusHash"%2C"Currency"%3A"VRSC"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"X11"%2C"Currency"%3A""}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"X11"%2C"Currency"%3A"DASH"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"X11"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"X11"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"X11"%2C"Currency"%3A"KZC"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X11"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X12"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"X13"%2C"Currency"%3A""}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"X13"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"X13"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"X13"%2C"Currency"%3A"ONION"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X13"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X14"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X15"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"NiceHash Internal"%2C"Algorithm"%3A"X16r"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"X16r"%2C"Currency"%3A"XRD"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X16r"%2C"Currency"%3A""}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"X16rt"%2C"Currency"%3A"AVN"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X16rt"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X16s"%2C"Currency"%3A""}%2C{"Name"%3A"MiningDutchPlus"%2C"Algorithm"%3A"X17"%2C"Currency"%3A""}%2C{"Name"%3A"ProHashingPlus"%2C"Algorithm"%3A"X17"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X17"%2C"Currency"%3A""}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"X22i"%2C"Currency"%3A"GLT"}%2C{"Name"%3A"MiningPoolHubCoins"%2C"Algorithm"%3A"Yescrypt"%2C"Currency"%3A"XMY"}%2C{"Name"%3A"ZergPoolCoinsPlus"%2C"Algorithm"%3A"Yescrypt"%2C"Currency"%3A"XMY"}%2C{"Name"%3A"ZPoolPlus"%2C"Algorithm"%3A"YespowerTide"%2C"Currency"%3A"TDC"}%5D'

Set-Location("c:\Users\Stephan\Desktop\NemosMiner\")
$ScriptBody = "using module .\Includes\Include.psm1"; $Script = [ScriptBlock]::Create($ScriptBody); . $Script

$Parameters = @{ }
$Variables = [Ordered]@{ }
$Variables.Miners = Get-Content ".\Debug\Miners.json" | ConvertFrom-Json
$Variables.Pools = Get-Content ".\Debug\Pools.json" | ConvertFrom-Json
$Variables.WatchdogTimers = Get-Content ".\Debug\WatchdogTimers.json" | ConvertFrom-Json
$Variables.ConfigFile = ".\Config\config.json"
$Variables.PoolsConfigFile = ".\Config\PoolsConfig.json"
# $Variables.Earnings = Get-Content ".\Debug\Earnings.json" | ConvertFrom-Json
$Variables.AvailableCommandLineParameters = @("Algorithm")
# $Variables.WatchdogTimers = Get-Content .\Debug\WatchdogTimers.json | ConvertFrom-Json
# $Variables.BalanceData = Get-Content "C:\Users\Stephan\Desktop\NemosMiner\Logs\BalancesTrackerData.json" | ConvertFrom-Json

# Load stats, required for stat management
Get-Stat | Out-Null

# Read-Config -ConfigFile $Variables.ConfigFile

$Request = $Request.Substring(42)
$Path = $Request -replace "\?.+"

# Parse any parameters in the URL - $Request looks like "+ ?a=b&c=d&message=Hello%20world"
# Decode any url escaped characters in the key and value
$Parameters = @{ }
$Request -replace ".+\?", "" -split '&' | Foreach-Object { 
    $Key, $Value = $_ -split '='
    # Decode any url escaped characters in the key and value
    $Key = [URI]::UnescapeDataString($Key)
    $Value = [URI]::UnescapeDataString($Value)
    If ($Key -and $Value) { $Parameters.$Key = $Value }
}
# Create a new response and the defaults for associated settings
$Response = $Context.Response
$ContentType = "application/json"
$StatusCode = 200
$Data = ""

# Set the proper content type, status code and data for each resource
                # Set the proper content type, status code and data for each resource
                Switch ($Path) { 
                    "/functions/api/stop" { 
                        Write-Message -Level Verbose "API: API stopped!"
                        Return
                    }
                    "/functions/balancedata/remove" { 
                        If ($Parameters.Data) { 
                            $BalanceDataEntries = ($Parameters.Data | ConvertFrom-Json -ErrorAction SilentlyContinue)
                            $Variables.BalanceData = @((Compare-Object $Variables.BalanceData $BalanceDataEntries -PassThru -Property DateTime, Pool, Currency, Wallet) | Select-Object -ExcludeProperty SideIndicator)
                            $Variables.BalanceData | ConvertTo-Json | Out-File ".\Logs\BalancesTrackerData.json"
                            If ($BalanceDataEntries.Count -gt 0) { 
                                $Variables.BalanceData | ConvertTo-Json | Out-File ".\Logs\BalancesTrackerData.json"
                                $Message = "$($BalanceDataEntries.Count) $(If ($BalanceDataEntries.Count -eq 1) { "balance data entry" } Else { "balance data entries" }) removed."
                                Write-Message -Level Verbose "Web GUI: $Message"
                                $Data = $Message
                            }
                            Else { 
                                $Data = "No matching entries found."
                            }
                            $Data = "<pre>$Data</pre>"
                            Break
                        }
                    }
                    "/functions/config/device/disable" { 
                        ForEach ($Key in $Parameters.Keys) {
                            If ($Values = @($Parameters.$Key -split ',' | Where-Object { $_ -notin $Config.ExcludeDeviceName })) { 
                                Try { 
                                    $Data = "Device configuration changed`n`nOld values:"
                                    $Data += "`nExcludeDeviceName: '[$($Config."ExcludeDeviceName" -join ', ')]'"
                                    $Config.ExcludeDeviceName = @((@($Config.ExcludeDeviceName) + $Values) | Sort-Object -Unique)
                                    $Data += "`n`nNew values:"
                                    $Data += "`nExcludeDeviceName: '[$($Config."ExcludeDeviceName" -join ', ')]'"
                                    $Data += "`n`nUpdated configFile`n$($Variables.ConfigFile)"
                                    Write-Config -ConfigFile $Variables.ConfigFile -Config $Config
                                    ForEach ($DeviceName in $Values) { 
                                        $Variables.Devices | Where-Object Name -EQ $DeviceName | ForEach-Object { 
                                            $_.State = [DeviceState]::Disabled
                                            If ($_.Status -like "* {*@*}") { $_.Status = "$($_.Status); will get disabled at end of cycle" }
                                            Else { $_.Status = "Disabled (ExcludeDeviceName: '$($_.Name)')" }
                                        }
                                    }
                                    Write-Message -Level Verbose "Web GUI: Device$(If ($Values.Count -ne 1) { "s" } ) '$($Values -join ', ')' disabled. Config file '$($Variables.ConfigFile)' updated."
                                }
                                Catch { 
                                    $Data = "Error saving config file`n'$($Variables.ConfigFile) $($Error[0])'."
                                }
                            }
                            Else { 
                                $Data = "No configuration change"
                            }
                        }
                        $Data = "<pre>$Data</pre>"
                        Break
                    }
                    "/functions/config/device/enable" { 
                        ForEach ($Key in $Parameters.Keys) {
                            If ($Values = @($Parameters.$Key -split ',' | Where-Object { $_ -in $Config.ExcludeDeviceName })) { 
                                Try { 
                                    $Data = "Device configuration changed`n`nOld values:"
                                    $Data += "`nExcludeDeviceName: '[$($Config."ExcludeDeviceName" -join ', ')]'"
                                    $Config.ExcludeDeviceName = @($Config.ExcludeDeviceName | Where-Object { $_ -notin $Values } | Sort-Object -Unique)
                                    $Data += "`n`nNew values:"
                                    $Data += "`nExcludeDeviceName: '[$($Config."ExcludeDeviceName" -join ', ')]'"
                                    $Data += "`n`nUpdated configFile`n$($Variables.ConfigFile)"
                                    Write-Config -ConfigFile $Variables.ConfigFile -Config $Config
                                    $Variables.Devices | Where-Object Name -in $Values | ForEach-Object { 
                                        $_.State = [DeviceState]::Enabled
                                        If ($_.Status -like "* {*@*}; will get disabled at end of cycle") { $_.Status = $_.Status -replace "; will get disabled at end of cycle" }
                                        Else { $_.Status = "Idle" }
                                    }
                                    Write-Message -Level Verbose "Web GUI: Device$(If ($Values.Count -ne 1) { "s" } ) '$($Values -join ', ')' enabled. Config file '$($Variables.ConfigFile)' updated."
                                }
                                Catch { 
                                    $Data = "Error saving config file`n'$($Variables.ConfigFile) $($Error[0])'."
                                }
                            }
                            Else {
                                $Data = "No configuration change"
                            }
                        }
                        $Data = "<pre>$Data</pre>"
                        Break
                    }
                    "/functions/config/set" { 
                        Try { 
                            Write-Config -ConfigFile $Variables.ConfigFile -Config ($Key | ConvertFrom-Json)
                            Read-Config -ConfigFile $Variables.ConfigFile
                            $Variables.Devices | Select-Object | Where-Object { $_.State -ne [DeviceState]::Unsupported } | ForEach-Object { 
                                If ($_.Name -in @($Config.ExcludeDeviceName)) { 
                                    $_.State = [DeviceState]::Disabled
                                    If ($_.Status -like "Mining *}") { $_.Status = "$($_.Status); will get disabled at end of cycle" }
                                }
                                Else { 
                                    $_.State = [DeviceState]::Enabled
                                    If ($_.Status -like "*; will get disabled at end of cycle") { $_.Status = $_.Status -replace "; will get disabled at end of cycle" } 
                                    If ($_.Status -like "Disabled *") { $_.Status = "Idle" }
                                }
                            }
                            $Variables.RestartCycle = $true

                            # Set operational values for text window
                            $Variables.ShowAccuracy = $Config.ShowAccuracy
                            $Variables.ShowAllMiners = $Config.ShowAllMiners
                            $Variables.ShowEarning = $Config.ShowEarning
                            $Variables.ShowEarningBias = $Config.ShowEarningBias
                            $Variables.ShowMinerFee = $Config.ShowMinerFee
                            $Variables.ShowPoolBalances = $Config.ShowPoolBalances
                            $Variables.ShowPoolFee = $Config.ShowPoolFee
                            $Variables.ShowPowerCost = $Config.ShowPowerCost
                            $Variables.ShowPowerUsage = $Config.ShowPowerUsage
                            $Variables.ShowProfit = $Config.ShowProfit
                            $Variables.ShowProfitBias = $Config.ShowProfitBias

                            Write-Message -Level Verbose "Web GUI: Configuration saved. It will become active in next cycle."
                            $Data = "Config saved to '$($Variables.ConfigFile)'. It will become active in next cycle."
                        }
                        Catch { 
                            $Data = "Error saving config file`n'$($Variables.ConfigFile)'."
                        }
                        $Data = "<pre>$Data</pre>"
                        Break
                    }
                    "/functions/file/edit" {
                        $Data = Edit-File $Parameters.FileName
                        Break
                    }
                    "/functions/file/showcontent" {
                        $Data = (Get-Content -Path $Parameters.FileName -Raw)
                        # $Data = (Get-Content -Path $Parameters.FileName -Raw) -replace "(?<!\x0d)\x0a", "<br>"
                        $ContentType = "text/html"
                        Break
                    }
                    "/functions/log/get" { 
                        $Lines = If ([Int]$Parameters.Lines) { [Int]$Parameters.Lines } Else { 100 }
                        $Data = " $(Get-Content -Path $Variables.LogFile -Tail $Lines | ForEach-Object { "$($_)`n" } )"
                        Break
                    }
                    "/functions/mining/getstatus" { 
                        $Data = If ($Variables.MiningStatus -eq $Variables.NewMiningStatus) {  ConvertTo-Json ($Variables.MiningStatus) } Else { ConvertTo-Json ($Variables.NewMiningStatus) }
                        Break
                    }
                    "/functions/mining/pause" { 
                        If ($Variables.MiningStatus -ne "Paused") { 
                            $Variables.NewMiningStatus = "Paused"
                            $Data = "Mining is being paused...`n$(If ($Variables.BalancesTrackerPollInterval -gt 0) { If (-not $Variables.BalancesTrackerRunspace) { "Balances Tracker starting..." } Else { "Balances Tracker running." } })"
                            $Variables.RestartCycle = $true
                        }
                        $Data = "<pre>$Data</pre>"
                        Break
                    }
                    "/functions/mining/start" { 
                        If ($Variables.MiningStatus -ne "Running") { 
                            $Variables.NewMiningStatus = "Running"
                            $Data = "Mining processes starting...`n$(If ($Variables.BalancesTrackerPollInterval -gt 0) { If (-not $Variables.BalancesTrackerRunspace) { "Balances Tracker starting..." } Else { "Balances Tracker running." } })"
                            $Variables.RestartCycle = $true
                        }
                        $Data = "<pre>$Data</pre>"
                        Break
                    }
                    "/functions/mining/stop" { 
                        If ($Variables.MiningStatus -ne "Idle") { 
                            $Variables.NewMiningStatus = "Idle"
                            $Data = "$($Variables.Branding.ProductLabel) is stopping...`n"
                            $Variables.RestartCycle = $true
                        }
                        $Data = "<pre>$Data</pre>"
                        Break
                    }
                    "/functions/stat/get" { 
                        $TempStats = @(If ($null -ne $Parameters.Value) { @($Stats.Keys | Where-Object { $_ -like "*$($Parameters.Type)" } | Where-Object { $Stats.$_.Live -eq $Parameters.Value } | ForEach-Object { $Stats.$_ }) } Else { @($Stats) })

                        If ($TempStats) { 
                            If ($null -ne $Parameters.Value) { 
                                $TempStats | Sort-Object Name | ForEach-Object { $Data += "$($_.Name -replace "_$($Parameters.Type)")`n" }
                                If ($Parameters.Type -eq "Hashrate") { $Data += "`n$($TempStats.Count) stat file$(if ($TempStats.Count -ne 1) { "s" }) with $($Parameters.Value)H/s $($Parameters.Type)." }
                                ElseIf ($Parameters.Type -eq "PowerUsage") { $Data += "`n$($TempStats.Count) stat file$(if ($TempStats.Count -ne 1) { "s" }) with $($Parameters.Value)W $($Parameters.Type)." }
                            }
                            Else { 
                                $Data = $TempStats | ConvertTo-Json
                            }
                        }
                        Else { 
                            $Data = "No matching stats found."
                        }
                        Break
                    }
                    "/functions/removeorphanedminerstats" { 
                        If ($StatNames = Remove-ObsoleteMinerStats) { 
                            $Data = $StatNames | ConvertTo-Json
                        }
                        Else { 
                            $Data = "No matching stats found."
                        }
                        Break
                    }
                    "/functions/stat/disable" { 
                        If ($Parameters.Pools) { 
                            $Names = @($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue).Name
                            $Algorithms = @($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue).Algorithm
                            $Currencies = @($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue).Currency
                            If ($Pools = @($Variables.Pools | Select-Object | Where-Object { $_.Name -in $Names -and $_.Algorithm -in $Algorithms -and $_.Currency -in $Currencies})) { 
                                $Pools | ForEach-Object { 
                                    $Stat_Name = "$($_.Name)_$($_.Algorithm)$(If ($_.Currency) { "-$($_.Currency)" })"
                                    $Data += "$($Stat_Name)`n"
                                    Disable-Stat -Name "$($Stat_Name)_Profit"
                                    $_.Disabled = $false
                                    $_.Reasons += "Disabled by user"
                                    $_.Reasons = $_.Reasons | Sort-Object -Unique
                                    $_.Available = $false
                                }
                                $Message = "$($Pools.Count) $(If ($Pools.Count -eq 1) { "pool" } Else { "pools" }) disabled."
                                Write-Message -Level Verbose "Web GUI: $Message"
                                $Data += "`n$Message"
                            }
                            Else { 
                                $Data = "No matching pool stats found."
                            }
                            Break
                        }
                        ElseIf ($Parameters.Miners) { 
                            If ($Miners = @(Compare-Object -PassThru -IncludeEqual -ExcludeDifferent @($Variables.Miners | Select-Object) @($Parameters.Miners | ConvertFrom-Json -ErrorAction SilentlyContinue | Select-Object) -Property Name, Algorithms)) { 
                                $Miners | Sort-Object Name, Algorithms | ForEach-Object { 
                                    $Data += "$($_.Name) ($($_.Algorithms -join " & "))`n"
                                    ForEach ($Worker in $_.Workers) { 
                                        Disable-Stat -Name "$($_.Name)_$($Worker.Pool.Algorithm)_Hashrate"
                                        $Worker.Hashrate = [Double]::NaN
                                    }
                                    $_.Disabled = $true
                                    $_.Reasons += "Disabled by user"
                                    $_.Reasons = $_.Reasons | Sort-Object -Unique
                                    $_.Available = $false
                                }
                                $Message = "$($Miners.Count) $(If ($Miners.Count -eq 1) { "Miner" } Else { "Miners" }) disbled."
                                Write-Message -Level Verbose "Web GUI: $Message"
                                $Data += "`n$Message"
                            }
                            Else { 
                                $Data = "No matching miner stats found."
                            }
                            Break
                        }
                    }
                    "/functions/stat/enable" { 
                        If ($Parameters.Pools) { 
                            $Names = @($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue).Name
                            $Algorithms = @($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue).Algorithm
                            $Currencies = @($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue).Currency
                            If ($Pools = @($Variables.Pools | Select-Object | Where-Object { $_.Name -in $Names -and $_.Algorithm -in $Algorithms -and $_.Currency -in $Currencies})) { 
                                $Pools | ForEach-Object { 
                                    $Stat_Name = "$($_.Name)_$($_.Algorithm)$(If ($_.Currency) { "-$($_.Currency)" })"
                                    $Data += "$($Stat_Name)`n"
                                    Enable-Stat -Name "$($Stat_Name)_Profit"
                                    $_.Disabled = $false
                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "Disabled by user" } | Sort-Object -Unique)
                                    If (-not $_.Reasons) { $_.Available = $true }
                                }
                                $Message = "$($Pools.Count) $(If ($Pools.Count -eq 1) { "pool" } Else { "pools" }) enabled."
                                Write-Message -Level Verbose "Web GUI: $Message"
                                $Data += "`n$Message"
                            }
                            Else { 
                                $Data = "No matching pool stats found."
                            }
                            Break
                        }
                        ElseIf ($Parameters.Miners) { 
                            If ($Miners = @(Compare-Object -PassThru -IncludeEqual -ExcludeDifferent @($Variables.Miners | Select-Object) @($Parameters.Miners | ConvertFrom-Json -ErrorAction SilentlyContinue | Select-Object) -Property Name, Algorithms)) { 
                                $Miners | Sort-Object Name, Algorithms | ForEach-Object { 
                                    $Data += "$($_.Name) ($($_.Algorithms -join " & "))`n"
                                    ForEach ($Worker in $_.Workers) { 
                                        Enable-Stat -Name "$($_.Name)_$($Worker.Pool.Algorithm)_Hashrate"
                                        $Worker.Hashrate = [Double]::NaN
                                    }
                                    $_.Disabled = $false
                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -ne "Disabled by user" } | Sort-Object -Unique)
                                    If (-not $_.Reasons) { $_.Available = $true }
                                }
                                $Message = "$($Miners.Count) $(If ($Miners.Count -eq 1) { "Miner" } Else { "Miners" }) enabled."
                                Write-Message -Level Verbose "Web GUI: $Message"
                                $Data += "`n$Message"
                            }
                            Else { 
                                $Data = "No matching miner stats found."
                            }
                            Break
                        }
                    }
                    "/functions/stat/remove" { 
                        If ($Parameters.Pools) { 
                            If ($Pools = @(Compare-Object -PassThru -IncludeEqual -ExcludeDifferent @($Variables.Pools | Select-Object) @($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue | Select-Object) -Property Algorithm, Currency, Name)) { 
                                $Pools | Sort-Object Name | ForEach-Object { 
                                    $Stat_Name = "$($_.Name)_$($_.Algorithm)$(If ($_.Currency) { "-$($_.Currency)" })"
                                    $Data += "$($Stat_Name)`n"
                                    Remove-Stat -Name "$($Stat_Name)_Profit"
                                    $_.Reasons = [String[]]@()
                                    $_.Price = $_.Price_Bias = $_.StablePrice = $_.Accuracy = [Double]::Nan
                                    $_.Available = $true
                                    $_.Disabled = $false
                                }
                                $Message = "Reset pool stats for $($Pools.Count) $(If ($Pools.Count -eq 1) { "pool" } Else { "pools" })."
                                Write-Message -Level Verbose "Web GUI: $Message"
                                $Data += "`n$Message"
                            }
                            Else { 
                                $Data = "No matching pool stats found."
                            }
                            Break
                        }
                        ElseIf ($Parameters.Miners -and $Parameters.Type -eq "Hashrate") { 
                            If ($Miners = @(Compare-Object -PassThru -IncludeEqual -ExcludeDifferent @($Variables.Miners | Select-Object) @($Parameters.Miners | ConvertFrom-Json -ErrorAction SilentlyContinue | Select-Object) -Property Name, Algorithms)) { 
                                $Miners | Sort-Object Name, Algorithms | ForEach-Object { 
                                    If ($_.Earning -eq 0) { $_.Available = $true }
                                    $_.Earning_Accuracy = [Double]::NaN
                                    $_.Activated = 0 # To allow 3 attempts
                                    $_.Disabled = $false
                                    $_.Benchmark = $true
                                    $_.Restart = $true
                                    $Data += "$($_.Name) ($($_.Algorithms -join " & "))`n"
                                    ForEach ($Worker in $_.Workers) { 
                                        Remove-Stat -Name "$($_.Name)_$($Worker.Pool.Algorithm)_Hashrate"
                                        $Worker.Hashrate = [Double]::NaN
                                    }
                                    # Also clear power usage
                                    Remove-Stat -Name "$($_.Name)$(If ($_.Algorithms.Count -eq 1) { "_$($_.Algorithms[1])" })_PowerUsage"
                                    $_.PowerUsage = $_.PowerCost = $_.Profit = $_.Profit_Bias = $_.Earning = $_.Earning_Bias = [Double]::NaN

                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -ne "Disabled by user" })
                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -ne "0 H/s Stat file" })
                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "Unreal profit data *" })
                                    If (-not $_.Reasons) { $_.Available = $true }
                                    If ($_.Status -eq "Disabled") { $_.Status = "Idle" }
                                }
                                Write-Message -Level Verbose "Web GUI: Re-benchmark triggered for $($Miners.Count) $(If ($Miners.Count -eq 1) { "miner" } Else { "miners" })."
                                $Data += "`n$(If ($Miners.Count -eq 1) { "The miner" } Else { "$($Miners.Count) miners" }) will re-benchmark."
                            }
                            Else { 
                                $Data = "No matching hashrate stats found."
                            }
                            Break
                        }
                        ElseIf ($Parameters.Miners -and $Parameters.Type -eq "PowerUsage") { 
                            If ($Miners = @(Compare-Object -PassThru -IncludeEqual -ExcludeDifferent @($Variables.Miners | Select-Object) @($Parameters.Miners | ConvertFrom-Json -ErrorAction SilentlyContinue | Select-Object) -Property Name, Algorithms)) { 
                                $Miners | Sort-Object Name, Algorithms | ForEach-Object { 
                                    If ($_.Earning -eq 0) { $_.Available = $true }
                                    If ($Variables.CalculatePowerCost) { 
                                        $_.MeasurePowerUsage = $true
                                        $_.Activated = 0 # To allow 3 attempts
                                    }
                                    $_.PowerUsage = [Double]::NaN
                                    $Stat_Name = "$($_.Name)$(If ($_.Algorithms.Count -eq 1) { "_$($_.Algorithms)" })"
                                    $Data += "$Stat_Name`n"
                                    Remove-Stat -Name "$($Stat_Name)_PowerUsage"
                                    $_.PowerUsage = $_.PowerCost = $_.Profit = $_.Profit_Bias = $_.Earning = $_.Earning_Bias = [Double]::NaN
                                    If ($_.Status -eq "Disabled") { $_.Status = "Idle" }
                                }
                                Write-Message -Level Verbose "Web GUI: Re-measure power usage triggered for $($Miners.Count) $(If ($Miners.Count -eq 1) { "miner" } Else { "miners" })." -Verbose
                                $Data += "`n$(If ($Miners.Count -eq 1) { "The miner" } Else { "$($Miners.Count) miners" }) will re-measure power usage."
                            }
                            Else { 
                                $Data = "No matching power usage stats found."
                            }
                            Break
                        }
                        If ($Parameters.Value) { $TempStats = @($Stats.Keys | Where-Object { $_ -like "*$($Parameters.Type)" } | Where-Object { $Stats.$_.Live -eq $Parameters.Value } | ForEach-Object { $Stats.$_ }) }
                        Else { $TempStats = @($Stats.Keys | Where-Object { $_ -like "*$($Parameters.Type)" } | ForEach-Object { $Stats.$_ }) } 
                        If ($TempStats) {
                            $TempStats | Sort-Object Name | ForEach-Object { 
                                Remove-Stat -Name $_.Name
                                $Data += "$($_.Name -replace "_$($Parameters.Type)")`n"
                            }
                            Write-Message -Level Info "Web GUI: Removed $($TempStats.Count) $($Parameters.Type) stat file$(If ($TempStats.Count -ne 1) { "s" })."
                            If ($Parameters.Type -eq "Hashrate") { $Data += "`nReset $($TempStats.Count) stat file$(if ($TempStats.Count -ne 1) { "s" }) with $($Parameters.Value)H/s $($Parameters.Type)." }
                            ElseIf ($Parameters.Type -eq "PowerUsage") { $Data += "`nReset $($TempStats.Count) stat file$(if ($TempStats.Count -ne 1) { "s" }) with $($Parameters.Value)W $($Parameters.Type)." }
                            ElseIf ($Parameters.Type -eq "Profit") { $Data += "`nReset $($TempStats.Count) pool stat file$(if ($TempStats.Count -ne 1) { "s" })." }
                        }
                        Else { 
                            $Data = "No matching stats found."
                        }
                        Break
                    }
                    "/functions/stat/set" { 
                        If ($Parameters.Miners -and $Parameters.Type -eq "Hashrate" -and $null -ne $Parameters.Value) { 
                            If ($Miners = @(Compare-Object -PassThru -IncludeEqual -ExcludeDifferent @($Variables.Miners | Select-Object) @($Parameters.Miners | ConvertFrom-Json -ErrorAction SilentlyContinue | Select-Object) -Property Name, Algorithms)) {
                                $Miners | Sort-Object Name, Algorithms | ForEach-Object {
                                    $_.Data = @()
                                    If ($Parameters.Value -le 0 -and $Parameters.Type -eq "Hashrate") { $_.Available = $false; $_.Disabled = $true }
                                    $Data += "$($_.Name) ($($_.Algorithms -join " & "))`n"
                                    ForEach ($Algorithm in $_.Algorithms) { 
                                        $Stat_Name = "$($_.Name)_$($Algorithm)_$($Parameters.Type)"
                                        If ($Parameters.Value -eq 0) { # Miner failed
                                            Remove-Stat -Name $Stat_Name
                                            $_.Profit = $_.Profit_Bias = $_.Earning = $_.Earning_Bias = $_.Earning_Accuracy = [Double]::NaN
                                            $_.Available = $false
                                            $_.Disabled = $false
                                            $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "Disabled by user" })
                                            If ($_.Reasons -notcontains "0 H/s Stat file" ) { $_.Reasons += "0 H/s Stat file" }
                                            $_.Status = [MinerStatus]::Failed
                                            Set-Stat -Name $Stat_Name -Value $Parameters.Value -FaultDetection $false | Out-Null
                                        }
                                        ElseIf ($Parameters.Value -eq -1) { # Miner disabled
                                            $_.Available = $false
                                            $_.Disabled = $true
                                            If ($_.Reasons -notcontains "Disabled by user") { $_.Reasons += "Disabled by user" }
                                            $_.Status = [MinerStatus]::Disabled
                                            Disable-Stat -Name $Stat_Name | Out-Null
                                        }
                                    }
                                }
                                Write-Message -Level Verbose "Web GUI: Disabled $($Miners.Count) $(If ($Miners.Count -eq 1) { "miner" } Else { "miners" })." -Verbose
                                $Data += "`n$(If ($Miners.Count -eq 1) { "The miner is" } Else { "$($Miners.Count) miners are" }) $(If ($Parameters.Value -eq 0) { "marked as failed" } ElseIf ($Parameters.Value -eq -1) { "disabled" } Else { "set to value $($Parameters.Value)" } )." 
                            }
                            Else { 
                                $Data = "No matching miners found."
                            }
                            Break
                        }
                    }
                    "/functions/switchinglog/clear" { 
                        Get-ChildItem -Path ".\Logs\switchinglog.csv" -File | Remove-Item -Force
                        $Data = "Switching log '.\Logs\switchinglog.csv' cleared."
                        Break
                    }
                    "/functions/variables/get" { 
                        If ($Key) { 
                            $Data = $Variables.($Key -replace '\\|/','.' -split '\.' | Select-Object -Last 1) | Get-SortedObject | ConvertTo-Json -Depth 10
                        }
                        Else { 
                            $Data = $Variables.Keys | Sort-Object | ConvertTo-Json -Depth 1
                        }
                        Break
                    }
                    "/functions/watchdogtimers/remove" { 
                        ForEach ($WatchdogTimer in ($Parameters.Miners | ConvertFrom-Json -ErrorAction SilentlyContinue)) { 
                            If ($WatchdogTimers = @($Variables.WatchdogTimers | Where-Object MinerName -EQ $WatchdogTimer.Name | Where-Object { $_.Algorithm -eq $WatchdogTimer.Algorithms })) {
                                # Remove Watchdog timers
                                $Variables.WatchdogTimers = @($Variables.WatchdogTimers | Where-Object { $_ -notin $WatchdogTimers })
                                $Data += "$($WatchdogTimer.Name) {$($WatchdogTimer.Algorithm -join ', ')}`n"

                                # Update miner
                                $Variables.Miners | Where-Object Name -EQ $WatchdogTimer.Name | Where-Object Algorithm -EQ $WatchdogTimer.Algorithm | ForEach-Object { 
                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "Miner suspended by watchdog *" })
                                    If (-not $_.Reasons) { $_.Available = $true }
                                }
                            }
                        }
                        ForEach ($WatchdogTimer in ($Parameters.Pools | ConvertFrom-Json -ErrorAction SilentlyContinue)) { 
                            If ($WatchdogTimers = @($Variables.WatchdogTimers | Where-Object PoolName -EQ $WatchdogTimer.Name | Where-Object { $_.Algorithm -EQ $WatchdogTimer.Algorithm })) {
                                # Remove Watchdog timers
                                $Variables.WatchdogTimers = @($Variables.WatchdogTimers | Where-Object { $_ -notin $WatchdogTimers })
                                $Data += "$($WatchdogTimer.Name) {$($WatchdogTimer.Algorithm -join ', ')}`n"

                                # Update pool
                                $Variables.Pools | Where-Object Name -EQ $WatchdogTimer.Name | Where-Object Algorithm -EQ $WatchdogTimer.Algorithm | ForEach-Object { 
                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "Algorithm@Pool suspended by watchdog" })
                                    $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "Pool suspended by watchdog*" })
                                    If (-not $_.Reasons) { $_.Available = $true }
                                }
                            }
                        }
                        If ($WatchdogTimers) { 
                            $Message = "$($Data.Count) $(If ($Data.Count -eq 1) { "watchdog timer" } Else { "watchdog timers" }) removed."
                            Write-Message -Level Verbose "Web GUI: $Message"
                            $Data += "`n$Message"
                        }
                        Else { 
                            $Data = "No matching watchdog timers found."
                        }
                        Break
                    }
                    "/functions/watchdogtimers/reset" { 
                        $Variables.WatchDogTimers = @()
                        $Variables.Miners | ForEach-Object { $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "Miner suspended by watchdog *" }); $_ } | Where-Object { -not $_.Reasons } | ForEach-Object { $_.Available = $true }
                        $Variables.Pools | ForEach-Object { $_.Reasons = @($_.Reasons | Where-Object { $_ -notlike "*Pool suspended by watchdog" }); $_ } | Where-Object { -not $_.Reasons } | ForEach-Object { $_.Available = $true }
                        Write-Message -Level Verbose "Web GUI: All watchdog timers reset."
                        $Data = "Watchdog timers will be recreated in next cycle."
                        Break
                    }
                    "/algorithms" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Algorithms | Select-Object)
                        Break
                    }
                    "/algorithms/lastused" { 
                        $Data = ConvertTo-Json -Depth 10 $Variables.AlgorithmsLastUsed
                        Break
                    }
                    "/allcurrencies" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.AllCurrencies)
                        break
                    }
                    "/apiversion" { 
                        $Data = $APIVersion
                        Break
                    }
                    "/balances" { 
                        $Data = ConvertTo-Json -Depth 10 ($Variables.Balances | Select-Object)
                        Break
                    }
                    "/balancedata" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.BalanceData | Sort-Object DateTime -Descending)
                        Break
                    }
                    "/btc" { 
                        $Data = $Variables.Rates.BTC.($Config.Currency)
                        Break
                    }
                    "/balancescurrencies" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.BalancesCurrencies)
                        break
                    }
                    "/brainjobs" { 
                        $Data = ConvertTo-Json -Depth 2 ($Variables.BrainJobs | Select-Object)
                        Break
                    }
                    "/coinnames" { 
                        $Data = Get-Content -Path ".\Data\CoinNames.json"
                        Break
                    }
                    "/config" {
                        $Data = ConvertTo-Json -Depth 10 (Get-Content -Path $Variables.ConfigFile | ConvertFrom-Json -Depth 10 | Get-SortedObject)
                        If (-not ($Data | ConvertFrom-Json).ConfigFileVersion) { 
                            $Data = ConvertTo-Json -Depth 10 ($Config | Select-Object -Property * -ExcludeProperty PoolsConfig)
                        }
                        Break
                    }
                    "/configfile" { 
                        $Data = $Variables.ConfigFile
                        break
                    }
                    "/configrunning" {
                        $Data = ConvertTo-Json -Depth 10 ($Config | Get-SortedObject)
                        Break
                    }
                    "/currency" { 
                        $Data = $Config.Currency
                        Break
                    }
                    "/currencyalgorithm" { 
                        $Data = Get-Content -Path ".\Data\CurrencyAlgorithm.json"
                        Break
                    }
                     "/dagdata" { 
                        $Data = ConvertTo-Json -Depth 10 ($Variables.DAGdata | Select-Object)
                        Break
                    }
                    "/devices" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Devices | Sort-Object Name| Select-Object | Sort-Object Name)
                        Break
                    }
                    "/devices/enabled" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Devices | Where-Object State -EQ "Enabled" | Select-Object | Sort-Object Name)
                        Break
                    }
                    "/devices/disabled" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Devices | Where-Object State -EQ "Disabled" | Select-Object | Sort-Object Name)
                        Break
                    }
                    "/devices/unsupported" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Devices | Where-Object State -EQ "Unsupported" | Select-Object | Sort-Object Name)
                        Break
                    }
                    "/defaultalgorithm" { 
                        $Data = ConvertTo-Json -Depth 10 (Get-DefaultAlgorithm)
                        Break
                    }
                    "/displayworkers" { 
                        If ($Config.ShowWorkerStatus -and $Config.MonitoringUser -and $Config.MonitoringServer -and $Variables.WorkersLastUpdated -lt (Get-Date).AddSeconds(-30)) { 
                            Read-MonitoringData
                        }
                        $DisplayWorkers = [System.Collections.ArrayList]@(
                            $Variables.Workers | Select-Object @(
                                @{ Name = "Algorithm"; Expression = { ($_.data | ForEach-Object { $_.Algorithm -split "," -join " & " }) -join "<br/>" } }, 
                                @{ Name = "Benchmark Hashrate"; Expression = { ($_.data | ForEach-Object { ($_.EstimatedSpeed | ForEach-Object { If ([Double]$_ -gt 0) { "$($_ | ConvertTo-Hash)/s" -replace "\s+", " " } Else { "-" } }) -join " & " }) -join "<br>" } }, 
                                @{ Name = "Currency"; Expression = { $_.Data.Currency | Select-Object -Unique } }, 
                                @{ Name = "EstimatedEarning"; Expression = { [Decimal](($_.Data.Earning | Measure-Object -Sum).Sum * $Variables.Rates.BTC.($_.Data.Currency | Select-Object -Unique)) } }, 
                                @{ Name = "EstimatedProfit"; Expression = { [Decimal]($_.Profit * $Variables.Rates.BTC.($_.Data.Currency | Select-Object -Unique)) } }, 
                                @{ Name = "LastSeen"; Expression = { "$($_.date)" } }, 
                                @{ Name = "Live Hashrate"; Expression = { ($_.data | ForEach-Object { ($_.CurrentSpeed | ForEach-Object { If ([Double]$_ -gt 0) { "$($_ | ConvertTo-Hash)/s" -replace "\s+", " " } Else { "-" } }) -join " & " }) -join "<br>" } }, 
                                @{ Name = "Miner"; Expression = { $_.data.name -join '<br/>'} }, 
                                @{ Name = "Pool"; Expression = { ($_.data | ForEach-Object { ($_.Pool -split "," | ForEach-Object { $_ -replace "Internal$", " (Internal)" -replace "External", " (External)" }) -join " & "}) -join "<br/>" } }, 
                                @{ Name = "Status"; Expression = { $_.status } }, 
                                @{ Name = "Version"; Expression = { $_.version } }, 
                                @{ Name = "Worker"; Expression = { $_.worker } }
                            ) | Sort-Object "Worker Name"
                        )
                        $Data = ConvertTo-Json @($DisplayWorkers | Select-Object)
                        Break
                    }
                    "/donationdata" { 
                        $Data =  ConvertTo-Json $Variables.DonationData
                        Break
                    }
                    "/driverversion" { 
                        $Data = ConvertTo-Json -Depth 10 ($Variables.DriverVersion | Select-Object)
                        Break
                    }
                    "/earningschartdata" { 
                        $Data =  ConvertTo-Json $Variables.EarningsChartData
                        Break
                    }
                    "/extracurrencies" { 
                        $Data = ConvertTo-Json -Depth 10 $Config.ExtraCurrencies
                        break
                    }
                    "/fiatcurrencies" { 
                        $Data = ConvertTo-Json -Depth 10 ($Variables.FIATcurrencies | Select-Object)
                        Break
                    }
                    "/miners" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.Miners | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process | ForEach-Object { If ($_.WorkersRunning) { $_ | Add-Member Workers $_.WorkersRunning -Force }; $_ } | Select-Object -Property * -ExcludeProperty WorkersRunning | Sort-Object Status, DeviceName, Name)
                        Break
                    }
                    "/miners/available" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.Miners | Where-Object Available | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process | Sort-Object Name)
                        Break
                    }
                    "/miners/best" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.MinersBest | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process | ConvertTo-Json -Depth 4 | ConvertFrom-Json | ForEach-Object { If ($_.WorkersRunning) { $_ | Add-Member Workers $_.WorkersRunning -Force }; $_ } | Select-Object -Property * -ExcludeProperty WorkersRunning | Sort-Object DeviceName)
                        Break
                    }
                    "/miners/best_combo" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.MinersBest_Combo | Sort-Object DeviceNames | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process)
                        Break
                    }
                    "/miners/best_combos" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.MinersBest_Combos | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process)
                        Break
                    }
                    "/miners/disabled" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.Miners | Where-Object { $_.Status -EQ [MinerStatus]::Disabled } | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process  | Sort-Object DeviceName, EndTime)
                        Break
                    }
                    "/miners/failed" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.Miners | Where-Object { $_.Status -EQ [MinerStatus]::Failed } | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process  | Sort-Object DeviceName, EndTime)
                        Break
                    }
                    "/miners/mostprofitable" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.MinersMostProfitable | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process | Sort-Object Status, DeviceName, @{Expression = "Earning_Bias"; Descending = $True })
                        Break
                    }
                    "/miners/running" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.Miners | Where-Object Available | Where-Object { $_.Status -EQ [MinerStatus]::Running } | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process, Workers | ConvertTo-Json -Depth 4 | ConvertFrom-Json | ForEach-Object { $_ | Add-Member Workers $_.WorkersRunning; $_ } | Select-Object -Property * -ExcludeProperty WorkersRunning)
                        Break
                    }
                    "/miners/unavailable" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.Miners | Where-Object Available -NE $true | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process | Sort-Object DeviceName, Name, Algorithm)
                        Break
                    }
                    "/miners_device_combos" { 
                        $Data = ConvertTo-Json -Depth 4 @($Variables.Miners_Device_Combos | Select-Object -Property * -ExcludeProperty Data, DataReaderJob, Devices, Process)
                        Break
                    }
                    "/miningpowercost" { 
                        $Data = $Variables.MiningPowerCost
                        Break
                    }
                    "/miningearning" { 
                        $Data = $Variables.MiningEarning
                        Break
                    }
                    "/miningprofit" { 
                        $Data = $Variables.MiningProfit
                        Break
                    }
                    "/poolsconfig" { 
                        $Data = ConvertTo-Json -Depth 10 ($Config.PoolsConfig | Select-Object)
                        Break
                    }
                    "/poolsconfigfile" { 
                        $Data = $Variables.PoolsConfigFile
                        Break
                    }
                    "/pooldata" { 
                        $Data = ConvertTo-Json -Depth 10 $Variables.PoolData
                        break
                    }
                    "/pools" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Pools | Select-Object | Sort-Object Algorithm, Name, Region)
                        Break
                    }
                    "/pools/added" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.PoolsAdded | Select-Object | Sort-Object Algorithm, Name, Region)
                        Break
                    }
                    "/pools/available" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Pools | Where-Object Available | Select-Object | Sort-Object Algorithm, Name, Region)
                        Break
                    }
                    "/pools/best" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.PoolsBest | Select-Object | Sort-Object Algorithm, Name, Region)
                        Break
                    }
                    "/pools/new" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.NewPools | Select-Object | Sort-Object Algorithm, Name, Region)
                        Break
                    }
                    "/pools/minersprimaryalgorithm" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.MinerPools[0] | Select-Object)
                        Break
                    }
                    "/pools/minerssecondaryalgorithm" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.MinerPools[1] | Select-Object)
                        Break
                    }
                    "/pools/lastearnings" { 
                        $Data = ConvertTo-Json -Depth 10 $Variables.PoolsLastEarnings
                        Break
                    }
                    "/pools/lastused" { 
                        $Data = ConvertTo-Json -Depth 10 $Variables.PoolsLastUsed
                        Break
                    }
                    "/pools/unavailable" { 
                        $Data = ConvertTo-Json -Depth 10  @($Variables.Pools | Where-Object Available -NE $true | Select-Object | Sort-Object Algorithm, Name, Region)
                        Break
                    }
                    "/pools/updated" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.PoolsUpdated | Select-Object | Sort-Object Algorithm, Name, Region)
                        Break
                    }
                    "/poolreasons" { 
                        $Data = ConvertTo-Json -Depth 10 (($Variables.Pools | Where-Object Available -NE $true).Reasons | Sort-Object -Unique)
                        Break
                    }
                    "/poolvariants" { 
                        $Data = ConvertTo-Json -Depth 10 $Variables.PoolVariants
                        break
                    }
                    "/rates" { 
                        $Data = ConvertTo-Json -Depth 10 ($Variables.Rates | Select-Object)
                        Break
                    }
                    "/regions" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Regions.PSObject.Properties.Value | Sort-Object -Unique)
                        Break
                    }
                    "/regionsdata" { 
                        $Data = ConvertTo-Json -Depth 10 $Variables.Regions
                        Break
                    }
                    "/stats" { 
                        $Data = ConvertTo-Json -Depth 10 ($Stats | Select-Object)
                        Break
                    }
                    "/summary" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.Summary | Select-Object)
                        Break
                    }
                    "/switchinglog" { 
                        $Data = ConvertTo-Json -Depth 10 @(Get-Content ".\Logs\switchinglog.csv" | ConvertFrom-Csv | Select-Object -Last 1000 | Sort-Object DateTime -Descending)
                        Break
                    }
                    "/unprofitablealgorithms" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.UnprofitableAlgorithms | Select-Object)
                        Break
                    }
                    "/watchdogtimers" { 
                        $Data = ConvertTo-Json -Depth 10 @($Variables.WatchdogTimers | Select-Object)
                        Break
                    }
                    "/wallets" { 
                        $Data = ConvertTo-Json -Depth 10 ($Config.Wallets | Select-Object)
                        Break
                    }
                    "/watchdogexpiration" { 
                        $Data = $Variables.WatchdogReset
                        Break
                    }
                    "/version" { 
                        $Data = ConvertTo-Json @("$($Variables.Branding.ProductLabel) Version: $($Variables.Branding.Version)", "API Version: $($Variables.APIVersion)", "PWSH Version: $($PSVersionTable.PSVersion.ToString())")
                        Break
                    }
                    Default { 
                        # Set index page
                        If ($Path -eq "/") { $Path = "/index.html" }

                        # Check if there is a file with the requested path
                        $Filename = "$BasePath$Path"
                        If (Test-Path -Path $Filename -PathType Leaf) { 
                            # If the file is a PowerShell script, execute it and return the output. A $Parameters parameter is sent built from the query string
                            # Otherwise, just return the contents of the file
                            $File = Get-ChildItem $Filename -File

                            If ($File.Extension -eq ".ps1") { 
                                $Data = & $File.FullName -Parameters $Parameters
                            }
                            Else { 
                                $Data = Get-Content $Filename -Raw

                                # Process server side includes for html files
                                # Includes are in the traditional '<!-- #include file="/path/filename.html" -->' format used by many web servers
                                If ($File.Extension -eq ".html") { 
                                    $IncludeRegex = [regex]'<!-- *#include *file="(.*)" *-->'
                                    $IncludeRegex.Matches($Data) | Foreach-Object { 
                                        $IncludeFile = $BasePath + '/' + $_.Groups[1].Value
                                        If (Test-Path -Path $IncludeFile -PathType Leaf) { 
                                            $IncludeData = Get-Content $IncludeFile -Raw
                                            $Data = $Data -replace $_.Value, $IncludeData
                                        }
                                    }
                                }
                            }

                            # Set content type based on file extension
                            If ($MIMETypes.ContainsKey($File.Extension)) { 
                                $ContentType = $MIMETypes[$File.Extension]
                            }
                            Else { 
                                # If it's an unrecognized file type, prompt for download
                                $ContentType = "application/octet-stream"
                            }
                        }
                        Else { 
                            $StatusCode = 404
                            $ContentType = "text/html"
                            $Data = "URI '$Path' is not a valid resource."
                        }
                    }
                }

# If $Data is null, the API will just return whatever data was in the previous request.  Instead, show an error
# This happens if the script just started and hasn't filled all the properties in yet. 
If ($Data -eq $null) { 
    $Data = @{ "Error" = "API data not available" } | ConvertTo-Json
}

# Fix for Powershell 5.1, cannot handle NaN in Json
If ($PSVersionTable.PSVersion -lt [Version]"6.0.0.0" ) { $Data = $Data -replace '":\s*NaN,', '":  "-",' }

$Data