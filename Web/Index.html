<!--#include file="/parts/head.html" -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 id="title" data-navbaractive="navdashboard" class="h2">Dashboard</h1>
</div>

<div id="toolbar">
  <button id="re-benchmark" class="btn btn-primary">Trigger re-benchmarking</button>
  <button id="re-measure" class="btn btn-primary">Trigger re-measuring power usage</button>
  <button id="disable" class="btn btn-danger">Disable Miner</button>
</div>

<h3>Running Miners</h3>

<table id="miners" class="table"
  data-toolbar="#toolbar"
  data-click-to-select="true"
  data-cache="true"
  data-toggle="table"
  data-icons="icons"
  data-show-button-text="true"
  data-remember-order="true"
  data-filter-control="true"
  data-disable-control-when-search="true"
  data-show-search-clear-button="true"
  data-show-columns="true"
  data-show-toggle="true"
  data-show-refresh="true"
  data-detail-view="true"
  data-detail-formatter="detailFormatter"
  data-url="/miners/running"
  data-response-handler="formatMiners"
  data-sort-name="tDevices"
  >

  <thead>
    <tr>
      <th data-field="state" data-checkbox="true"></th>
      <th data-field="tName" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Name</th>
      <th data-field="tDevices" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Devices</th>
      <th data-field="Type" data-sortable="true" data-filter-control="select" data-visible="false" data-filter-strict-search="true">Type</th>
      <th data-field="StatusMessage" data-sortable="true" data-filter-control="select" data-filter-strict-search="false" data-visible="true">Status</th>
      <th data-field="Earning" data-align="right" data-sortable="true" data-formatter="formatBTC" data-title-tooltip = "per 24hrs (estimated)">Earning</th>
      <th data-field="Profit" data-align="right" data-sortable="true" data-formatter="formatBTC" data-title-tooltip = "per 24hrs (estimated)">Profit</th>
      <th data-field="Earning_Bias" data-align="right" data-sortable="true" data-formatter="formatBTC" data-title-tooltip = "per 24hrs (estimated)" data-visible="false">Earning Bias</th>
      <th data-field="Profit_Bias" data-align="right" data-sortable="true" data-formatter="formatBTC" data-title-tooltip = "per 24hrs (estimated)" data-visible="false">Profit Bias</th>
      <th data-field="PowerUsage" data-align="right" data-sortable="true" data-formatter="formatWatt" data-title-tooltip = "per 24hrs (estimated)">Power Usage</th>
      <th data-field="PowerCost" data-align="right" data-sortable="true" data-formatter="formatBTC" data-title-tooltip = "per 24hrs (estimated)">Power Cost</th>
      <th data-field="tPrimaryAlgorithm" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Primary Algorithm</th>
      <th data-field="tPrimarySpeed" data-sortable="true" data-formatter="formatHashRateValue" data-filter-strict-search="true">Benchmarked Speed</th>
      <th data-field="tPrimarySpeedLive" data-sortable="true" data-formatter="formatHashRateValue">Actual Speed</th>
      <th data-field="tSecondaryAlgorithm" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Secondary Algorithm</th>
      <th data-field="tSecondarySpeed" data-sortable="true" data-formatter="formatHashRateValue">Benchmarked Speed</th>
      <th data-field="tTotalMiningDuration" data-sortable="true" data-visible="false">Total Mining Duration</th>
      <th data-field="tSecondarySpeedLive" data-sortable="true" data-formatter="formatHashRateValue">Actual Speed</th>
      <th data-field="Port" data-sortable="true" data-filter-control="input" data-filter-strict-search="false" data-visible="false">API Port</th>
      <th data-field="Best" data-sortable="true" data-filter-control="input" data-filter-strict-search="false" data-visible="false">Best</th>
      <th data-field="Activated" data-sortable="true" data-filter-control="input" data-filter-strict-search="false" data-visible="false">Activated</th>
      <th data-field="New" data-sortable="true" data-filter-control="input" data-filter-strict-search="false" data-visible="false">New</th>
    </tr>
  </thead>
</table>

<div id="balances" .style.display="none">
  <h3 class="mt-4">Balances</h3>

  <div id="balanceboxes" class="card-deck"></div>

  <script id="poolbalance_template" type="text/x-handlebars-template">
    <div class="card m-3 {{#if total}}text-white bg-primary{{else}}text-dark bg-light{{/if}}" style="min-width: {{#if total}}90%{{else}}200px{{/if}}">
      <div class="card-header text-center">
        {{#if total}}<h5>{{name}}</h5>last hour:<br>&#8776; {{growth1sum}} {{firstcurrency}}<br>&#8776; {{growth1summbtc}} mBTC<br><br>last 24 hours:<br>&#8776; {{growth24sum}} {{firstcurrency}}<br>&#8776; {{growth24summbtc}} mBTC
        {{else}}<h5><a href="{{uri}}" target="_blank">{{name}}</a></h5>{{updated}}<br>avg. &#8776; {{avghourlygrowth}} {{thresholdcurrency}}/h
        {{/if}}
      </div>
      <div class="card-body text-center">
        <p class="card-text currencies">
          {{#each balances}}
          <b>{{@key}}: {{this}}</b>
          <br/>
          {{/each}}
        </p>
        {{#if total}}{{else}}
        <p class="payout">
          <b>{{percentage}}%</b> of <b>{{payoutthreshold}} {{thresholdcurrency}}</b><br/>payout threshold<br/>
          <br/>Estimated Paydate:<br><b>{{paydate}}</b>
        </p>
        {{/if}}
      </div>
    </div>
  </div>
</script>

<!-- Start of page scripts -->

<script type="text/javascript">
  var $table = $('#miners');
  var $querysize = 10000;

  // get BTC rate of first currency
  var rate;

  $.ajax({url: '/btcratefirstcurrency',
    success: function(result) {
      rate = result;
    }
  });

  document.getElementById("balances").style.display = "none";

  $('#re-benchmark').click(function () {
    var $data = $table.bootstrapTable('getSelections');
    if ($data.length >= 1) {
      $data = JSON.stringify($data.map($element => ({Name: $element.Name, Algorithm: $element.Algorithm})));
      if ($data.length >= $querysize) {
        alert('Too many objects selected, cannot proceed.\nUnselect some objects and try again.\n\n(Query size: ' + $data.length + '/' + $querysize + ')');
      }
      else {
        $command = '/functions/stat/remove?Miners=' + encodeURIComponent($data) + "&Type=HashRate";
        $('.modal-body').load($command, function() {
          $('.modal-title').text($('#re-benchmark').text());
          $('#myModal').modal({show:true});
        });
        $('#miners').bootstrapTable('refresh');
      }
    }
  });

  $('#re-measure').click(function () {
    var $data = $table.bootstrapTable('getSelections');
    if ($data.length >= 1) {
      $data = JSON.stringify($data.map($element => ({Name: $element.Name, Algorithm: $element.Algorithm})));
      if ($data.length >= $querysize) {
        alert('Too many objects selected, cannot proceed.\nUnselect some objects and try again.\n\n(Query size: ' + $data.length + '/' + $querysize + ')');
      }
      else {
        $command = '/functions/stat/remove?Miners=' + encodeURIComponent($data) + "&Type=PowerUsage";
        $('.modal-body').load($command, function() {
          $('.modal-title').text($('#re-measure').text());
          $('#myModal').modal({show:true});
        });
        $('#miners').bootstrapTable('refresh');
      }
    }
  });

  $('#disable').click(function () {
    var $data = $table.bootstrapTable('getSelections');
    if ($data.length >= 1) {
      $data = JSON.stringify($data.map($element => ({Name: $element.Name, Algorithm: $element.Algorithm})));
      if ($data.length >= $querysize) {
        alert('Too many objects selected, cannot proceed.\nUnselect some objects and try again.\n\n(Query size: ' + $data.length + '/' + $querysize + ')')
      }
      else {
        $command = '/functions/stat/set?Miners=' + encodeURIComponent($data) + "&Type=HashRate&Value=0";
        $('.modal-body').load($command, function() {
          $('.modal-title').text($('#disable').text());
          $('#myModal').modal({show:true});
        });
        $('#miners').bootstrapTable('refresh');
      }
    }
  });

  $(function() {
    function updatePoolBalances() {
      var balances = document.getElementById("balances");
      var data_sum = {name: "Total from all Pools", balances: {}, total: true};
      var rates = {};

      $.ajax({url: '/rates',
        success: function(result) {
          if (result != null) {
            rates = result;

            $.ajax({url: '/currencies',
              success: function(result) {
                if (result != null) { 
                  currencies = result;

                  $.ajax({url: '/earnings',
                    success: function(result) {
                      if (result != null) { 
                        document.getElementById("balances").style.display = "block";

                        $("#balanceboxes").empty();
                        var template = Handlebars.compile($("#poolbalance_template").html());
                        var footer = new RegExp("-.+|=.+");
                        var growth1_sum = 0;
                        var growth24_sum = 0;
                        $.each(result, function(index, item) {
                          growth1_sum = growth1_sum + item.Growth1;
                          growth24_sum = growth24_sum + item.Growth24;
                          if (!(footer.test(item.Pool))) {
                            var data = {name: item.Pool.replace('Internal', ' (Internal)').replace('External', ' (External)'), updated: formatDate(item.Updated), payoutthreshold: item.PayoutThreshold, thresholdcurrency: item.PayoutThresholdCurrency, currency: item.Currency, uri: item.Uri, balances: {}, paydate: formatDate(item.EstimatedPayDate), percentage: (item.Balance / item.PayoutThreshold * 100 * rates['BTC'][item.PayoutThresholdCurrency.replace("^m")] * rates[item.PayoutThresholdCurrency.replace("^m")][item.PayoutThresholdCurrency]).toFixed(1), avghourlygrowth: (item.AvgHourlyGrowth * 1000).toFixed(8)};
                            $.each(currencies, function(cindex, currency) {
                              data["balances"][currency] = (item.Balance * rates['BTC'][currency]).toFixed(8);
                              if (!(data_sum["balances"][currency])) {data_sum["balances"][currency] = 0}
                              data_sum["balances"][currency] = data_sum["balances"][currency] + item.Balance * rates['BTC'][currency];
                            });
                            $("#balanceboxes").append(template(data));
                          }
                        });
                        data_sum["growth1summbtc"] = (growth1_sum * 1000).toFixed(8);
                        data_sum["growth24summbtc"] = (growth24_sum * 1000).toFixed(8);
                        data_sum["firstcurrency"] = currencies[0];
                        data_sum["growth1sum"] = (growth1_sum * rates['BTC'][currencies[0]]).toFixed(8);
                        data_sum["growth24sum"] = (growth24_sum * rates['BTC'][currencies[0]]).toFixed(8);
                        $("#balanceboxes").append(template(data_sum));
                      }
                    }
                  });
                }
              }
            });
          }
        }
      });

      $.ajax({url: '/btcratefirstcurrency',
        success: function(result) {
          rate = result;
        }
      });
    }
    updatePoolBalances();

    window.setInterval(function() { 
      updatePoolBalances();
      $table.bootstrapTable("refresh");
    }, 60000);

  });

</script>

<!-- End of page scripts -->
<!--#include file="/parts/foot.html" -->